# Phase 0.5: A2A Protocol Local Implementation

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement A2A (Agent-to-Agent) Protocol for local Claude instance collaboration, enabling task delegation and multi-agent workflows on the same machine.

**Architecture:** Full A2A Protocol implementation with local HTTP+JSON transport. Task-based communication with proper lifecycle management. AgentCard-based agent discovery. Dedicated Task Queue (SQLite) separate from Knowledge Graph.

**Tech Stack:**
- TypeScript, Zod validation
- A2A Protocol Specification (https://a2a-protocol.org/latest/)
- SQLite for Task Queue and Agent Registry
- Express.js for HTTP server
- MCP SDK for Claude Code integration

---

## ğŸ“š A2A Protocol Summary

**What we learned from https://a2a-protocol.org/latest/:**

1. **A2A vs MCP**:
   - MCP: Agent â†” Tool communication
   - A2A: Agent â†” Agent communication
   - They are complementary

2. **Core concepts**:
   - **Task**: Fundamental unit of work with lifecycle states
   - **Message**: Communication turns between agents
   - **AgentCard**: Agent self-description (capabilities, endpoints)
   - **Service Operations**: SendMessage, GetTask, ListTasks, CancelTask

3. **Task Lifecycle**:
   ```
   SUBMITTED â†’ WORKING â†’ COMPLETED
                 â†“          â†‘
              FAILED     CANCELED
                 â†“          â†‘
          INPUT_REQUIRED  REJECTED
   ```

4. **Transport**: Supports JSON-RPC, gRPC, HTTP+JSON
   - **Phase 0.5**: HTTP+JSON over localhost only

5. **Security**: A2A supports auth, but Phase 0.5 skips it (local only)

---

## ğŸ—ï¸ Phase 0.5 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Claude Code Instance (e.g., "Alice")            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          MCP Tools (A2A Client Interface)               â”‚ â”‚
â”‚  â”‚  - a2a-send-task                                        â”‚ â”‚
â”‚  â”‚  - a2a-get-task                                         â”‚ â”‚
â”‚  â”‚  - a2a-list-tasks                                       â”‚ â”‚
â”‚  â”‚  - a2a-list-agents                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚ HTTP calls to other agents                   â”‚
â”‚               â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            A2A HTTP Server (Express.js)               â”‚  â”‚
â”‚  â”‚  Endpoints:                                           â”‚  â”‚
â”‚  â”‚  - POST /a2a/send-message   â†’ SendMessage             â”‚  â”‚
â”‚  â”‚  - GET  /a2a/tasks/:id      â†’ GetTask                 â”‚  â”‚
â”‚  â”‚  - GET  /a2a/tasks          â†’ ListTasks               â”‚  â”‚
â”‚  â”‚  - GET  /a2a/agent-card     â†’ GetAgentCard            â”‚  â”‚
â”‚  â”‚  Port: Auto-assigned (3000-3999)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                              â”‚
â”‚               â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Task Queue (SQLite)                         â”‚  â”‚
â”‚  â”‚  ~/.claude-code-buddy/a2a-tasks-{agent_id}.db        â”‚  â”‚
â”‚  â”‚  - tasks, messages, artifacts tables                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Shared Agent Registry (SQLite)                             â”‚
â”‚  ~/.claude-code-buddy/a2a-registry.db                       â”‚
â”‚  - Stores: agent_id â†’ {port, capabilities, status}          â”‚
â”‚  - Enables discovery without network broadcast               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key decisions:**
- Each Claude instance runs its own A2A HTTP server
- Agent discovery via shared SQLite registry
- Task storage in per-agent SQLite databases
- Knowledge Graph OPTIONAL (for long-term memory only)

---

## ğŸ“‹ Implementation Plan

### Prerequisites

**Branch**: `feature/phase-0.5-a2a-protocol` (already created)

**Dependencies to add**:
```bash
npm install express uuid
npm install --save-dev @types/express @types/uuid
```

### Task 1: Add A2A Protocol Type Definitions (~2 hours)

Create TypeScript interfaces matching A2A Protocol spec.

**Files to create:**
- `src/a2a/types/protocol.ts`
- `src/a2a/types/task.ts`
- `src/a2a/types/message.ts`
- `src/a2a/types/agent-card.ts`
- `src/a2a/types/index.ts`

**Key types:**
- `Task`, `TaskState`, `TaskStatus`
- `Message`, `Part`, `Role`
- `AgentCard`, `Skill`, `AgentCapabilities`
- `SendMessageRequest`, `GetTaskRequest`, `ListTasksRequest`

**Acceptance:**
- [ ] TypeScript compiles with no errors
- [ ] All core A2A types defined
- [ ] Exported via index.ts

### Task 2: Implement Task Queue Storage (~3 hours)

SQLite database for task storage.

**Files to create:**
- `src/a2a/storage/schemas.sql` (DB schema)
- `src/a2a/storage/TaskQueue.ts` (CRUD operations)
- `src/a2a/storage/index.ts`

**Database:**
- Path: `~/.claude-code-buddy/a2a-tasks-{agent_id}.db`
- Tables: `tasks`, `messages`, `artifacts`

**Methods:**
- `createTask()` - Create new task
- `getTask()` - Fetch task by ID
- `listTasks()` - List with filters
- `updateTaskStatus()` - Update state
- `addMessage()` - Add to history
- `addArtifact()` - Add output

**Acceptance:**
- [ ] Database schema created successfully
- [ ] All CRUD operations work
- [ ] Manual test: create task, fetch it back

### Task 3: Implement Agent Registry (~2 hours)

Shared SQLite registry for agent discovery.

**Files to create:**
- `src/a2a/storage/registry-schemas.sql`
- `src/a2a/storage/AgentRegistry.ts`

**Database:**
- Path: `~/.claude-code-buddy/a2a-registry.db`
- Table: `agents`

**Methods:**
- `register()` - Add/update agent
- `get()` - Get agent by ID
- `listActive()` - List active agents
- `heartbeat()` - Update last_heartbeat
- `deactivate()` - Mark inactive
- `cleanupStale()` - Remove stale agents

**Acceptance:**
- [ ] Registry schema created
- [ ] Agent CRUD works
- [ ] Manual test: register 2 agents, list them

### Task 4: Implement A2A HTTP Server (~4 hours)

Express.js server implementing A2A HTTP+JSON binding.

**Files to create:**
- `src/a2a/server/A2AServer.ts` (Express app)
- `src/a2a/server/routes.ts` (Route handlers)
- `src/a2a/server/middleware.ts` (Error handling)
- `src/a2a/server/index.ts`

**Routes:**
- `POST /a2a/send-message` â†’ SendMessage
- `GET /a2a/tasks/:taskId` â†’ GetTask
- `GET /a2a/tasks` â†’ ListTasks
- `GET /a2a/agent-card` â†’ GetAgentCard

**Features:**
- Auto-assign port (3000-3999)
- Register in Agent Registry on startup
- Heartbeat every 60 seconds
- Deregister on shutdown

**Acceptance:**
- [ ] Server starts on available port
- [ ] All routes respond correctly
- [ ] Manual test: curl endpoints

### Task 5: Implement A2A HTTP Client (~2 hours)

HTTP client for calling other agents.

**Files to create:**
- `src/a2a/client/A2AClient.ts`
- `src/a2a/client/index.ts`

**Methods:**
- `sendMessage()` - POST to /a2a/send-message
- `getTask()` - GET /a2a/tasks/:id
- `listTasks()` - GET /a2a/tasks
- `getAgentCard()` - GET /a2a/agent-card

**Features:**
- Auto-discover agent port from registry
- Handle HTTP errors gracefully
- Return typed responses

**Acceptance:**
- [ ] Client can call local servers
- [ ] Manual test: send message between 2 instances

### Task 6: Implement Task Executor (~3 hours)

Execute tasks by calling Claude API.

**Files to create:**
- `src/a2a/executor/TaskExecutor.ts`
- `src/a2a/executor/index.ts`

**Simplified executor (Phase 0.5):**
- Accept task â†’ immediately return COMPLETED
- Generate simple artifact with echo response
- Phase 1 will add real Claude API execution

**Acceptance:**
- [ ] Tasks transition SUBMITTED â†’ WORKING â†’ COMPLETED
- [ ] Artifact generated with response
- [ ] Manual test: send task, check completion

### Task 7: Add MCP Tools for A2A (~4 hours)

Expose A2A operations as MCP tools.

**Files to create/modify:**
- Create: `src/mcp/handlers/A2AToolHandlers.ts`
- Modify: `src/mcp/ToolDefinitions.ts` (add tools)
- Modify: `src/mcp/ToolRouter.ts` (route tools)
- Modify: `src/mcp/validation.ts` (add schemas)

**New MCP Tools:**
- `a2a-send-task` - Send task to another agent
- `a2a-get-task` - Get task status
- `a2a-list-tasks` - List own tasks
- `a2a-list-agents` - List available agents

**Acceptance:**
- [ ] All 4 tools defined
- [ ] Tools routed correctly
- [ ] Manual test in Claude Code

### Task 8: Add Server Lifecycle Management (~2 hours)

Start/stop A2A server with CCB.

**Files to modify:**
- `src/index.ts` - Start server on CCB init
- `src/mcp/server-bootstrap.ts` - Add shutdown hook

**Features:**
- Auto-start server when CCB starts
- Generate agent_id from env or UUID
- Register in agent registry
- Deregister on shutdown

**Acceptance:**
- [ ] Server auto-starts
- [ ] Agent appears in registry
- [ ] Server stops cleanly

### Task 9: Integration Testing (~3 hours)

End-to-end test with 2+ Claude instances.

**Test scenarios:**
1. Start 2 Claude Code instances (Alice, Bob)
2. Alice sends task to Bob via `a2a-send-task`
3. Verify task appears in Bob's task list
4. Bob completes task (auto-execution)
5. Alice checks task status â†’ COMPLETED
6. Verify artifact generated

**Create test documentation:**
- `docs/testing/phase-0.5-a2a-manual-tests.md`

**Acceptance:**
- [ ] All test scenarios pass
- [ ] Documentation created
- [ ] No errors in logs

### Task 10: Documentation (~2 hours)

Update all documentation.

**Files to create/modify:**
- Create: `docs/features/a2a-agent-collaboration.md`
- Modify: `README.md` (add A2A feature)
- Modify: `CHANGELOG.md` (add Phase 0.5 entry)

**Documentation includes:**
- A2A overview
- How to use MCP tools
- Example workflows
- Architecture diagrams
- Limitations of Phase 0.5

**Acceptance:**
- [ ] All docs updated
- [ ] Examples work as documented

---

## ğŸ¯ Phase 0.5 Scope & Limitations

### âœ… Included in Phase 0.5

- A2A Protocol HTTP+JSON binding (local only)
- Task-based communication
- Agent discovery via registry
- Task lifecycle management (simplified)
- MCP tool integration
- AgentCard support

### âŒ NOT Included (Future Phases)

- Streaming (Phase 1)
- Push notifications (Phase 1)
- Real Claude API execution (Phase 1) - Phase 0.5 just returns COMPLETED
- Cross-machine communication (Phase 2)
- Authentication/Authorization (Phase 2)
- gRPC/JSON-RPC transports (Phase 3)

---

## ğŸ“Š Estimation Summary

| Task | Estimated Hours | Lines of Code |
|------|----------------|---------------|
| 1. Type definitions | 2 | 200 |
| 2. Task Queue | 3 | 300 |
| 3. Agent Registry | 2 | 200 |
| 4. HTTP Server | 4 | 400 |
| 5. HTTP Client | 2 | 150 |
| 6. Task Executor | 3 | 150 |
| 7. MCP Tools | 4 | 300 |
| 8. Lifecycle | 2 | 100 |
| 9. Testing | 3 | - |
| 10. Documentation | 2 | - |
| **Total** | **27 hours** | **~1800 lines** |

**Risk level:** Medium (new subsystem, well-isolated)

---

## ğŸš€ Execution Plan

**Option 1: Sequential execution in this session**
- Work through tasks 1-10 sequentially
- Commit after each task
- Test incrementally

**Option 2: Subagent-driven development**
- Dispatch separate subagent for each task
- Parallel execution where possible
- Code review between tasks

**User: Which approach do you prefer?**

---

## âœ… Final Checklist

Before marking Phase 0.5 complete:

- [ ] All TypeScript compiles without errors
- [ ] `npm run build` succeeds
- [ ] All tests pass (manual + integration)
- [ ] 2+ Claude instances can collaborate
- [ ] Tasks persist in SQLite
- [ ] Agent registry works
- [ ] All documentation updated
- [ ] CHANGELOG updated
- [ ] No security warnings
- [ ] Code reviewed
- [ ] Feature branch ready for PR

---

**Plan Status:** Ready for execution
**Branch:** `feature/phase-0.5-a2a-protocol`
**Next step:** Await user approval, then begin Task 1
