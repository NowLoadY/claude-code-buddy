import { randomBytes } from 'crypto';
export class AttributionManager {
    attributions = [];
    maxStoredAttributions = 100;
    eventBus;
    constructor(eventBus) {
        this.eventBus = eventBus;
    }
    recordSuccess(agentIds, taskDescription, metadata) {
        const attribution = {
            id: this.generateId(),
            type: 'success',
            timestamp: new Date(),
            agentIds,
            taskDescription,
            metadata,
        };
        this.storeAttribution(attribution);
        this.eventBus.emitAttribution(attribution);
    }
    recordError(agentIds, taskDescription, error, suggestGitHubIssue = true) {
        const attribution = {
            id: this.generateId(),
            type: 'error',
            timestamp: new Date(),
            agentIds,
            taskDescription,
            metadata: {
                error: {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                },
                suggestGitHubIssue,
            },
        };
        this.storeAttribution(attribution);
        this.eventBus.emitAttribution(attribution);
    }
    generateIssueSuggestion(attribution, error) {
        const title = `Error: ${error.message.substring(0, 80)}`;
        const sanitizedStack = this.sanitizeSensitiveData(error.stack || '');
        const sanitizedMessage = this.sanitizeSensitiveData(error.message);
        const body = `## Error Report

**Description:** ${attribution.taskDescription}

**Error Type:** ${error.name}

**Error Message:** ${sanitizedMessage}

**Agent(s) Involved:** ${attribution.agentIds.join(', ')}

**Timestamp:** ${attribution.timestamp.toISOString()}

### Stack Trace

\`\`\`
${sanitizedStack}
\`\`\`

### Environment

- **claude-code-buddy Version:** [Auto-detected]
- **Node.js Version:** ${process.version}
- **Platform:** ${process.platform}

### Additional Context

[Add any relevant context about what you were trying to do]

---

*This issue was auto-generated by claude-code-buddy error reporting. Sensitive data has been sanitized.*`;
        return {
            title,
            body,
            labels: ['bug', 'claude-code-buddy'],
        };
    }
    getRecentAttributions(limit = 10) {
        return this.attributions.slice(0, limit);
    }
    storeAttribution(attribution) {
        this.attributions.unshift(attribution);
        if (this.attributions.length > this.maxStoredAttributions) {
            this.attributions.length = this.maxStoredAttributions;
        }
    }
    sanitizeSensitiveData(text) {
        let sanitized = text;
        sanitized = sanitized.replace(/\/Users\/[^\/]+/g, '/Users/[USER]');
        sanitized = sanitized.replace(/\/home\/[^\/]+/g, '/home/[USER]');
        sanitized = sanitized.replace(/C:\\Users\\[^\\]+/g, 'C:\\Users\\[USER]');
        sanitized = sanitized.replace(/sk-[a-zA-Z0-9]{20,}/g, 'sk-[REDACTED]');
        sanitized = sanitized.replace(/ghp_[a-zA-Z0-9]{20,}/g, 'ghp_[REDACTED]');
        sanitized = sanitized.replace(/API_KEY=\S+/g, 'API_KEY=[REDACTED]');
        sanitized = sanitized.replace(/token:\s*\S+/gi, 'token: [REDACTED]');
        sanitized = sanitized.replace(/password:\s*\S+/gi, 'password: [REDACTED]');
        sanitized = sanitized.replace(/passwd=\S+/gi, 'passwd=[REDACTED]');
        return sanitized;
    }
    generateId() {
        return `attr-${randomBytes(8).toString('hex')}`;
    }
}
//# sourceMappingURL=AttributionManager.js.map